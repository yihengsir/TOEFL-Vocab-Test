<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEFL è¯æ±‡å¬å†™æµ‹è¯• (é”‹é”‹è€å¸ˆ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for speaker icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow-y: auto;
        }

        .main-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            text-align: center;
        }

        .input-field {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1.125rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        .feedback-correct {
            background-color: #d1fae5; /* Light green */
            border-color: #10b981;
        }

        .feedback-incorrect {
            background-color: #fee2e2; /* Light red */
            border-color: #ef4444;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .play-button {
            background: none;
            border: none;
            color: #3b82f6;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: 0.5rem;
            padding: 0;
            vertical-align: middle;
            transition: color 0.2s;
        }
        .play-button:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-4">
            TOEFL è¯æ±‡å¬å†™æµ‹è¯• (fromé”‹é”‹è€å¸ˆ)
        </h1>

        <div id="quiz-area" class="flex flex-col gap-6">
            <div id="question-display" class="bg-blue-100 text-blue-900 text-3xl font-bold py-6 px-4 rounded-lg shadow-inner">
                åŠ è½½è¯æ±‡...
            </div>

            <input type="text" id="answer-input" class="input-field" placeholder="åœ¨æ­¤è¾“å…¥è‹±æ–‡è¯æ±‡æˆ–çŸ­è¯­..." autofocus>

            <div id="example-sentence-display" class="bg-gray-50 p-4 rounded-lg shadow-inner text-gray-700 text-sm italic min-h-[60px] flex items-center justify-center">
                ç‚¹å‡» "è·å–ä¾‹å¥" æŸ¥çœ‹ä¸Šä¸‹æ–‡
            </div>

            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="get-example-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
                    è·å–ä¾‹å¥
                </button>
                <button id="check-answer-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300">
                    æ£€æŸ¥ç­”æ¡ˆ
                </button>
                <button id="next-word-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 hidden">
                    ä¸‹ä¸€ä¸ª
                </button>
            </div>

            <div class="flex justify-center mt-4">
                <button id="end-test-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300">
                    ç»“æŸæµ‹è¯•
                </button>
            </div>

            <div id="feedback-message" class="text-lg font-semibold min-h-[30px]"></div>

            <div id="final-results-area" class="hidden flex flex-col gap-4 mt-6">
                <h2 class="text-2xl font-bold text-gray-800">æœ¬æ¬¡ç»ƒä¹ ç»“æœ</h2>
                <div id="results-list" class="text-left bg-gray-50 p-4 rounded-lg shadow-inner"></div>
                <button id="restart-test-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300">
                    é‡æ–°å¼€å§‹ç»ƒä¹ 
                </button>
            </div>
        </div>
    </div>

    <script>
        const questionDisplay = document.getElementById('question-display');
        const answerInput = document.getElementById('answer-input');
        const getExampleBtn = document.getElementById('get-example-btn');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const nextWordBtn = document.getElementById('next-word-btn');
        const endTestBtn = document.getElementById('end-test-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const exampleSentenceDisplay = document.getElementById('example-sentence-display');
        const finalResultsArea = document.getElementById('final-results-area');
        const resultsList = document.getElementById('results-list');
        const restartTestBtn = document.getElementById('restart-test-btn');

        let vocabularyData = []; // This will be populated by fetching expressions.json
        let shuffledVocabulary = []; // Shuffled list for the current test
        let currentWordIndex = 0; // Tracks position in shuffledVocabulary
        let correctAnswersCount = 0;
        let questionsAttempted = 0; // Tracks total questions answered in the current session
        let incorrectAnswers = []; // To store details of incorrect answers for final review

        // LLM API Key (leave empty, Canvas provides it at runtime)
        const apiKey = "AIzaSyD7Tb_4ttDNI__kLiLgVyuZgCt-fcoQLCA";
        let speechSynth = window.speechSynthesis; // Web Speech API for pronunciation
        let voicesLoaded = false; // Flag to track if voices are loaded

        /**
         * Shuffles an array randomly using the Fisher-Yates algorithm.
         * @param {Array} array - The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Plays the pronunciation of a given word.
         * @param {string} word - The word to pronounce.
         */
        function playPronunciation(word) {
            // Check if SpeechSynthesis API is supported and if voices are loaded
            if (!speechSynth || !voicesLoaded) {
                console.warn('SpeechSynthesis API not ready or supported in this browser.');
                // feedbackMessage.textContent = 'æŠ±æ­‰ï¼Œå½“å‰è®¾å¤‡ä¸æ”¯æŒè¯­éŸ³æ’­æ”¾ã€‚'; // å¯ä»¥é€‰æ‹©ç»™ç”¨æˆ·æç¤º
                return;
            }

            // If already speaking, cancel the current utterance before speaking a new one
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'en-US'; // Set language for English pronunciation
            utterance.volume = 1;     // Volume (0 to 1)
            utterance.rate = 1;       // Rate (0.1 to 10)
            utterance.pitch = 1;      // Pitch (0 to 2)

            // Optional: Choose a specific voice if you have a preference after voices are loaded
            // let selectedVoice = speechSynth.getVoices().find(voice => voice.lang === 'en-US' && voice.name.includes('Google US English'));
            // if (selectedVoice) {
            //     utterance.voice = selectedVoice;
            // }

            speechSynth.speak(utterance);
        }

        /**
         * Creates and returns a play button element.
         * @param {string} wordToSpeak - The word to be spoken when the button is clicked.
         * @returns {HTMLButtonElement} The play button element.
         */
        function createPlayButton(wordToSpeak) {
            const button = document.createElement('button');
            button.classList.add('play-button');
            button.innerHTML = '<i class="fas fa-volume-up"></i>'; // Font Awesome speaker icon
            button.title = `æ’­æ”¾ "${wordToSpeak}" çš„å‘éŸ³`;
            button.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering parent element's events (e.g., if inside a larger clickable area)
                playPronunciation(wordToSpeak);
            });
            return button;
        }


        /**
         * Loads vocabulary data from expressions.json.
         */
        async function loadVocabulary() {
            questionDisplay.textContent = 'åŠ è½½è¯æ±‡ä¸­...';
            try {
                const response = await fetch('expressions.json'); // Fetch the external JSON file
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                vocabularyData = await response.json();
                if (vocabularyData.length === 0) {
                    questionDisplay.textContent = 'è¯æ±‡åˆ—è¡¨ä¸ºç©ºã€‚è¯·åœ¨ expressions.json ä¸­æ·»åŠ è¯æ±‡ã€‚';
                    return;
                }
                initializeTest();
            } catch (error) {
                questionDisplay.textContent = 'åŠ è½½è¯æ±‡å¤±è´¥ã€‚è¯·æ£€æŸ¥ expressions.json æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ï¼Œæˆ–ç½‘ç»œè¿æ¥ã€‚';
                console.error('Failed to load vocabulary:', error);
            }
        }

        /**
         * Initializes or resets the dictation test for endless practice.
         */
        function initializeTest() {
            shuffledVocabulary = shuffleArray([...vocabularyData]); // Shuffle for a fresh test session
            currentWordIndex = 0;
            correctAnswersCount = 0;
            questionsAttempted = 0;
            incorrectAnswers = [];

            // Reset UI elements
            finalResultsArea.classList.add('hidden');
            restartTestBtn.classList.add('hidden');
            endTestBtn.classList.remove('hidden'); // Show End Test button
            answerInput.classList.remove('feedback-correct', 'feedback-incorrect');
            answerInput.readOnly = false;
            answerInput.value = '';
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600');
            exampleSentenceDisplay.textContent = 'ç‚¹å‡» "è·å–ä¾‹å¥" æŸ¥çœ‹ä¸Šä¸‹æ–‡';
            getExampleBtn.disabled = false;
            checkAnswerBtn.classList.remove('hidden');
            nextWordBtn.classList.add('hidden'); // Hide next button initially

            loadQuestion();
        }

        /**
         * Loads the current Chinese word/phrase for dictation.
         * Loops back to the start of shuffled list for endless practice.
         */
        function loadQuestion() {
            // Loop back to the beginning if all words in the shuffled list have been shown
            if (currentWordIndex >= shuffledVocabulary.length) {
                shuffledVocabulary = shuffleArray([...vocabularyData]); // Re-shuffle for new cycle
                currentWordIndex = 0;
            }

            const currentPair = shuffledVocabulary[currentWordIndex];
            questionDisplay.textContent = currentPair.chinese;
            answerInput.value = ''; // Clear previous input
            answerInput.classList.remove('feedback-correct', 'feedback-incorrect');
            answerInput.readOnly = false; // Make input editable
            answerInput.focus(); // Focus input for quick typing
            feedbackMessage.textContent = '';
            feedbackMessage.classList.remove('text-green-600', 'text-red-600');
            nextWordBtn.classList.add('hidden'); // Hide next button
            checkAnswerBtn.classList.remove('hidden'); // Show check button
            exampleSentenceDisplay.textContent = 'ç‚¹å‡» "è·å–ä¾‹å¥" æŸ¥çœ‹ä¸Šä¸‹æ–‡'; // Reset example sentence display
            getExampleBtn.disabled = false; // Re-enable get example button
        }

        /**
         * Checks the student's typed answer against the correct English expression.
         */
        function checkCurrentAnswer() {
            questionsAttempted++; // Increment attempted count for current session
            const typedAnswer = answerInput.value.trim();
            const correctEnglish = shuffledVocabulary[currentWordIndex].english.trim();

            answerInput.readOnly = true; // Prevent further edits after checking
            getExampleBtn.disabled = true; // Disable example sentence after checking

            if (typedAnswer.toLowerCase() === correctEnglish.toLowerCase()) {
                feedbackMessage.textContent = 'æ­£ç¡®ï¼ğŸ‘';
                feedbackMessage.classList.remove('text-red-600');
                feedbackMessage.classList.add('text-green-600');
                answerInput.classList.add('feedback-correct');
                correctAnswersCount++;
                playPronunciation(correctEnglish); // Play pronunciation on correct answer
            } else {
                feedbackMessage.innerHTML = `é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯: "${correctEnglish}"`;
                feedbackMessage.appendChild(createPlayButton(correctEnglish)); // Add play button
                feedbackMessage.classList.remove('text-green-600');
                feedbackMessage.classList.add('text-red-600');
                answerInput.classList.add('feedback-incorrect');
                incorrectAnswers.push({
                    chinese: shuffledVocabulary[currentWordIndex].chinese,
                    typed: typedAnswer,
                    correct: correctEnglish
                });
            }

            checkAnswerBtn.classList.add('hidden'); // Hide check button
            nextWordBtn.classList.remove('hidden'); // Show next button
        }

        /**
         * Transitions to the next word in the sequence.
         */
        function nextWord() {
            currentWordIndex++;
            loadQuestion();
        }

        /**
         * Ends the current practice session and shows the results.
         */
        function endTest() {
            questionDisplay.textContent = `ç»ƒä¹ ç»“æŸï¼`;
            answerInput.classList.add('hidden'); // Hide input
            getExampleBtn.classList.add('hidden');
            checkAnswerBtn.classList.add('hidden');
            nextWordBtn.classList.add('hidden');
            endTestBtn.classList.add('hidden'); // Hide End Test button
            feedbackMessage.textContent = '';
            exampleSentenceDisplay.classList.add('hidden');

            finalResultsArea.classList.remove('hidden');
            restartTestBtn.classList.remove('hidden');

            resultsList.innerHTML = '';
            if (questionsAttempted === 0) {
                resultsList.innerHTML = '<p class="text-gray-700">æ‚¨è¿˜æ²¡æœ‰å¼€å§‹ç»ƒä¹ å“¦ï¼</p>';
            } else if (incorrectAnswers.length === 0 && correctAnswersCount === questionsAttempted) {
                resultsList.innerHTML = `<p class="text-green-700">å¤ªæ£’äº†ï¼æœ¬æ¬¡ç»ƒä¹ æ‚¨ç­”å¯¹äº† ${correctAnswersCount} / ${questionsAttempted} é¢˜ï¼Œæ‰€æœ‰é¢˜ç›®éƒ½æ­£ç¡®ï¼</p>`;
            } else {
                const summary = document.createElement('p');
                summary.classList.add('font-bold', 'mb-4', 'text-gray-800');
                summary.textContent = `æœ¬æ¬¡ç»ƒä¹ æ‚¨ç­”å¯¹äº† ${correctAnswersCount} / ${questionsAttempted} é¢˜ã€‚`;
                resultsList.appendChild(summary);

                const incorrectHeader = document.createElement('p');
                incorrectHeader.classList.add('font-bold', 'mb-2', 'text-red-700');
                incorrectHeader.textContent = `ä»¥ä¸‹æ˜¯æ‚¨ç­”é”™çš„é¢˜ç›® (${incorrectAnswers.length} é¢˜):`;
                resultsList.appendChild(incorrectHeader);

                incorrectAnswers.forEach(item => {
                    const li = document.createElement('li');
                    li.classList.add('mb-2', 'pb-2', 'border-b', 'border-gray-200', 'flex', 'flex-col');
                    li.innerHTML = `
                        <p><strong>ä¸­æ–‡:</strong> ${item.chinese}</p>
                        <p class="flex items-center"><strong>æ‚¨è¾“å…¥:</strong> <span class="text-red-600">${item.typed || '[æœªè¾“å…¥]'}</span></p>
                        <p class="flex items-center"><strong>æ­£ç¡®ç­”æ¡ˆ:</strong> <span class="text-green-600">${item.correct}</span></p>
                    `;
                    // Add play button next to the correct answer in the results list
                    const correctSpan = li.querySelector('.text-green-600');
                    if (correctSpan) {
                        correctSpan.parentNode.appendChild(createPlayButton(item.correct));
                    }
                    resultsList.appendChild(li);
                });
            }
        }

        /**
         * Generates an example sentence using the Gemini API (gemini-2.0-flash).
         * Optimized to require correct input/checked answer first.
         */
        async function getExampleSentence() {
            const currentPair = shuffledVocabulary[currentWordIndex];
            const englishWord = currentPair.english; // Always use the correct word for example sentence

            // --- æ–°å¢çš„é€»è¾‘ï¼šä¾‹å¥è·å–æ¡ä»¶ä¼˜åŒ– ---
            // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œæˆ–è€…ç­”æ¡ˆå·²ç»æ£€æŸ¥è¿‡ä½†é”™è¯¯ï¼Œåˆ™æç¤ºç”¨æˆ·
            const isAnswerEmpty = answerInput.value.trim() === '';
            const isAnswerChecked = answerInput.readOnly;
            const isAnswerCorrect = answerInput.classList.contains('feedback-correct');

            if (isAnswerEmpty && !isAnswerChecked) { // å¦‚æœæ²¡è¾“å…¥ä¸”è¿˜æ²¡æ£€æŸ¥
                exampleSentenceDisplay.textContent = 'è¯·è¾“å…¥è‹±æ–‡è¯æ±‡æˆ–çŸ­è¯­åå†è·å–ä¾‹å¥ã€‚';
                return;
            } else if (isAnswerChecked && !isAnswerCorrect) { // å¦‚æœå·²ç»æ£€æŸ¥ä¸”ç­”æ¡ˆé”™è¯¯
                 exampleSentenceDisplay.textContent = 'è¯·æ£€æŸ¥æ‚¨çš„ç­”æ¡ˆï¼ˆçº¢è‰²éƒ¨åˆ†ï¼‰ï¼Œå¹¶æŸ¥çœ‹æ­£ç¡®ç­”æ¡ˆï¼Œå†è·å–ä¾‹å¥ã€‚';
                 return;
            }
            // --- ç»“æŸæ–°å¢é€»è¾‘ ---

            exampleSentenceDisplay.innerHTML = '<div class="loading-spinner"></div>'; // Show loading spinner
            getExampleBtn.disabled = true; // Disable button during loading

            try {
                const prompt = `è¯·æä¾›ä¸€ä¸ªå…³äºè‹±æ–‡è¯æ±‡æˆ–çŸ­è¯­ "${englishWord}" çš„ä¾‹å¥ã€‚ä¾‹å¥éœ€é€‚åˆä¸­çº§è‹±è¯­å­¦ä¹ è€…ï¼Œä¸”å¥å­å†…å®¹é¿å…è¿‡äºç®€å•æˆ–è¿‡äºå¤æ‚ã€‚`;
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    exampleSentenceDisplay.textContent = `ä¾‹å¥: "${text}"`;
                } else {
                    exampleSentenceDisplay.textContent = 'æ— æ³•ç”Ÿæˆä¾‹å¥ã€‚è¯·ç¨åå†è¯•ã€‚';
                    console.error('LLM response structure unexpected:', result);
                }
            } catch (error) {
                exampleSentenceDisplay.textContent = 'è·å–ä¾‹å¥å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚';
                console.error('Error calling LLM API:', error);
            } finally {
                if (!answerInput.readOnly) { // Only re-enable if answer hasn't been checked yet
                    getExampleBtn.disabled = false;
                }
            }
        }

        // --- è¯­éŸ³åˆæˆåˆå§‹åŒ–åŠäº‹ä»¶ç›‘å¬ ---
        // å°è¯•åœ¨é¡µé¢åŠ è½½æ—¶å°±åŠ è½½è¯­éŸ³èµ„æº
        if (speechSynth) {
            speechSynth.onvoiceschanged = () => {
                voicesLoaded = true;
                console.log('SpeechSynthesis voices loaded.');
                // Optional: Play a tiny silent sound to "activate" Web Speech API on some mobile browsers
                // This is a common workaround but not guaranteed to work everywhere.
                // const silentUtterance = new SpeechSynthesisUtterance('');
                // speechSynth.speak(silentUtterance);
            };
            // ç«‹å³å°è¯•åŠ è½½ä¸€æ¬¡ï¼Œä»¥é˜² onvoiceschanged å·²ç»è§¦å‘
            if (speechSynth.getVoices().length > 0) {
                voicesLoaded = true;
                console.log('SpeechSynthesis voices already available.');
            }
        } else {
            console.warn('æµè§ˆå™¨ä¸æ”¯æŒ SpeechSynthesis APIã€‚å‘éŸ³åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚');
        }
        // --- ç»“æŸè¯­éŸ³åˆæˆåˆå§‹åŒ– ---


        // Event Listeners
        checkAnswerBtn.addEventListener('click', checkCurrentAnswer);
        nextWordBtn.addEventListener('click', nextWord);
        endTestBtn.addEventListener('click', endTest); // New End Test button listener
        restartTestBtn.addEventListener('click', initializeTest);
        getExampleBtn.addEventListener('click', getExampleSentence);

        // Allow pressing Enter key to check answer or move to next
        answerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (!checkAnswerBtn.classList.contains('hidden')) {
                    checkCurrentAnswer();
                } else if (!nextWordBtn.classList.contains('hidden')) {
                    nextWord();
                }
            }
        });


        // Initialize the test by loading vocabulary when the page loads
        document.addEventListener('DOMContentLoaded', loadVocabulary);
    </script>
</body>
</html>
